[![Maven Central](https://img.shields.io/maven-central/v/org.hisp.dhis.rules/rule-engine?label=maven%20central)](https://central.sonatype.com/artifact/org.hisp.dhis.rules/rule-engine)
[![NPM Version](https://img.shields.io/npm/v/@dhis2/rule-engine)](https://www.npmjs.com/package/@dhis2/rule-engine)
[![KDoc link](https://img.shields.io/badge/API_reference-KDoc-blue)](https://dhis2.github.io/dhis2-rule-engine/api/)

# DHIS2 Rule Engine

The **DHIS2 Rule Engine** is a multiplatform library for evaluating and validating program rules in DHIS2.

It allows you to:
- Validate **program rule** and **program rule action** expressions.
- Evaluate program rules against metadata, enrollments, events, program rule variables, and environmental data.

The library is implemented as a **Kotlin Multiplatform project**, producing both **Java** and **JavaScript** libraries for use in DHIS2 client and server environments.

---

## API Overview

The public API exposes five main methods:

1. **`validate(expression, dataItemStore)`**  
   Validates that an expression has correct syntax and evaluates to a boolean value.  
   Use this to check program rule *condition* expressions.

2. **`validateDataFieldExpression(expression, dataItemStore)`**  
   Validates that an expression has correct syntax, but does not require it to be a boolean.  
   Use this to check *data field* expressions (e.g., calculations, assignments).

3. **`evaluateAll(enrollmentTarget, eventsTarget, executionContext)`**  
   Evaluates all program rules for a given enrollment and all its related events.  
   Returns the complete set of rule effects applicable to the enrollment and its events.

4. **`evaluate(target, ruleEvents, executionContext)`**  
   Evaluates program rules for an **enrollment target**.  
   Useful when you want to process rules that apply at the enrollment level.

5. **`evaluate(target, ruleEnrollment, ruleEvents, executionContext)`**  
   Evaluates program rules for an **event target** within an enrollment.  
   Useful when processing rules scoped to a specific event.

---

## Supporting Concepts

- **`DataItemStore`**  
  A mapping of variable names to their descriptions.  
  It defines which variables are available in expressions, ensuring validation and evaluation are meaningful.

- **`ExecutionContext`**  
  Provides all necessary information for evaluation, including:
    - Program rules
    - Rule variables
    - Supplementary data
    - Constant values

---

## Further Reading

For more details about program rules in DHIS2, see the [official documentation](https://docs.dhis2.org/en/develop/using-the-api/dhis-core-version-master/metadata.html#webapi_program_rules).


## Development

### API Validator
This library uses the [Binary Compatibility Validator plugin](https://github.com/Kotlin/binary-compatibility-validator), which verifies that there are no changes in the public API of the library.

The way of work is: there is a file generated by the plugin (`api/rule-engine.api`) with the binary representation of the expected public API. The plugin has a task (`apiCheck`) that verifies that the public API of the code matches the expected API in the file.

If there is an intentional change in the public API, this file must be updated to reflect the changes and included as part of the pull request. It can be updated running the task `apiDump`. This task can be run in the command line (`./gradlew apiDump`) or using Gradle window in Intellij.

### Version
Library version is defined in the file `build.gradle.kts`. The version must be manually increased
and include the `-SNAPSHOT` suffix. Please make sure the version is updated before opening the PR.

### Publications

On merged pull request to `main`:
- Production release to Maven.
- Production release to NPMJS.

On pull request creation/update:
- Snapshot release to Maven.

On demand:
- Beta releases to NPMJS can be triggered on demand by using the action "Publish NPM beta".
  Please make sure you select the right branch in the selector.

Publication can be skipped by adding `[skip publish]` to the pull request title.
